<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Создание полигона по изображению</title>
  <style>
    #container {
      position: relative;
      display: inline-block;
    }

    #image-container {
      display: block;
      max-width: 100%;
      border: 1px solid #ccc;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    #coords {
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    #uploader {
      margin-bottom: 10px;
    }
    
    #svg-xml-container {
      margin-top: 20px;
    }
    
    #svg-xml {
      padding: 10px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      max-height: 300px;
      overflow: auto;
      font-family: monospace;
      white-space: pre-wrap;
    }
    
    .svg-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }
    
    .svg-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      cursor: crosshair;
    }
    
    .button {
      padding: 5px 10px;
      margin-right: 5px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .button:hover {
      background: #45a049;
    }
    
    .controls {
      margin-bottom: 5px;
    }
    /* Добавлено для кнопок копирования */
    .coords-controls {
      margin: 10px 0;
    }
  </style>
</head>
<body>

<input type="file" id="uploader" accept="image/*,.svg">
<div id="container">
  <div id="image-container"></div>
  <canvas id="canvas"></canvas>
</div>
<div class="coords-controls">
  <button id="copy-coords-button" class="button">Копировать координаты</button>
</div>
<pre id="coords">Координаты появятся здесь…</pre>
<div id="svg-xml-container">
  <div class="controls">
    <button id="copy-button" class="button">Копировать XML</button>
  </div>
  <div id="svg-xml">XML SVG-файла появится здесь…</div>
</div>

<script>
  const uploader = document.getElementById('uploader');
  const imageContainer = document.getElementById('image-container');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const coordsDisplay = document.getElementById('coords');
  const svgXmlDisplay = document.getElementById('svg-xml');
  const copyButton = document.getElementById('copy-button');
  const copyCoordsButton = document.getElementById('copy-coords-button'); // Новая кнопка
  let points = [];
  let currentImageElement = null;
  let svgOverlay = null;
  let currentSvgXml = '';

  uploader.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Очищаем контейнер
    imageContainer.innerHTML = '';
    points = [];
    svgXmlDisplay.textContent = 'XML SVG-файла появится здесь…';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Проверяем, является ли файл SVG
    if (file.name.endsWith('.svg') || file.type === 'image/svg+xml') {
      try {
        let text = await file.text();
        
        // Удаляем <?xml version="1.0" ?>
        text = text.replace(/<\?xml version="1.0" \?>\n?/, '');
        currentSvgXml = text;
        svgXmlDisplay.textContent = text;
        
        // Создаем wrapper для SVG
        const wrapper = document.createElement('div');
        wrapper.className = 'svg-wrapper';
        
        // Создаем object для SVG
        const object = document.createElement('object');
        object.type = 'image/svg+xml';
        object.data = URL.createObjectURL(file);
        object.style.width = '100%';
        object.style.height = '100%';
        
        // Создаем overlay для перехвата кликов
        svgOverlay = document.createElement('div');
        svgOverlay.className = 'svg-overlay';
        
        wrapper.appendChild(object);
        wrapper.appendChild(svgOverlay);
        imageContainer.appendChild(wrapper);
        
        object.onload = () => {
          currentImageElement = object;
          // Обновляем размеры canvas после загрузки
          setTimeout(() => {
            canvas.width = imageContainer.clientWidth;
            canvas.height = imageContainer.clientHeight;
          }, 50);
        };
        
        // Назначаем обработчик кликов на overlay
        svgOverlay.addEventListener('click', handleImageClick);
        
      } catch (error) {
        svgXmlDisplay.textContent = 'Ошибка при чтении SVG файла: ' + error.message;
      }
    } else {
      // Обработка обычных изображений
      svgXmlDisplay.textContent = 'Загружен файл не SVG формата';
      const img = document.createElement('img');
      img.alt = 'Загруженное изображение';
      
      img.onload = () => {
        currentImageElement = img;
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
      };
      
      img.src = URL.createObjectURL(file);
      imageContainer.appendChild(img);
      
      // Назначаем обработчик кликов на изображение
      img.addEventListener('click', handleImageClick);
    }
  });

  copyButton.addEventListener('click', () => {
    if (!currentSvgXml) return;
    
    navigator.clipboard.writeText(currentSvgXml)
      .then(() => {
        const originalText = copyButton.textContent;
        copyButton.textContent = 'Скопировано!';
        setTimeout(() => {
          copyButton.textContent = originalText;
        }, 2000);
      })
      .catch(err => {
        console.error('Ошибка копирования: ', err);
      });
  });

  copyCoordsButton.addEventListener('click', () => {
    if (points.length === 0) {
      alert('Нет координат для копирования!');
      return;
    }
    
    const coordText = points.map(p => `${p.x},${p.y}`).join(' ');
    const textToCopy = `${coordText}`;
    
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        copyCoordsButton.textContent = 'Скопировано!';
        setTimeout(() => {
          copyCoordsButton.textContent = 'Копировать координаты';
        }, 2000);
      })
      .catch(err => {
        console.error('Ошибка копирования:', err);
        alert('Ошибка копирования!');
      });
  });

  function handleImageClick(e) {
    if (!currentImageElement) return;
    
    let rect;
    let width, height;
    
    if (currentImageElement.tagName === 'OBJECT') {
      // Для SVG в object
      rect = currentImageElement.getBoundingClientRect();
      width = rect.width;
      height = rect.height;
    } else {
      // Для обычных изображений
      rect = currentImageElement.getBoundingClientRect();
      width = currentImageElement.clientWidth;
      height = currentImageElement.clientHeight;
    }
    
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const percentX = (x / width).toFixed(2);
    const percentY = (y / height).toFixed(2);
    points.push({ x: percentX, y: percentY });
    drawPolygon();
    showCoords();
  }

  function drawPolygon() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (points.length < 2) return;
    ctx.beginPath();
    ctx.moveTo(points[0].x * canvas.width, points[0].y * canvas.height);
    for (let i = 1; i < points.length; i++) {
      ctx.lineTo(points[i].x * canvas.width, points[i].y * canvas.height);
    }
    ctx.closePath();
    ctx.strokeStyle = '#34eb46';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Рисуем точки
    points.forEach(point => {
      ctx.beginPath();
      ctx.arc(point.x * canvas.width, point.y * canvas.height, 4, 0, Math.PI * 2);
      ctx.fillStyle = '#34eb46';
      ctx.fill();
    });
  }

  function showCoords() {
    const coordPairs = points.map(p => `${p.x},${p.y}`);
    coordsDisplay.textContent = 'Координаты полигона:\n' + coordPairs.join(' ');
  }
</script>

</body>
</html>
